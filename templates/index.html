<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>LINEAL Timber EC5 Design</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --main:#1e3a8a; --accent:#3b82f6; --soft:#f1f5f9;
    }
    body { background: var(--soft); color:#111; font-family: "Inter", sans-serif; }
    h2 { color: var(--main); font-weight: 600; }
    .card { border:none; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,.06); }
    .btn-primary { background:var(--accent); border:none; }
    .result-box { background:#fff; border-radius:12px; padding:1rem; margin-bottom:1rem; font-size:0.95rem; }
    .util-pass { color:#15803d; font-weight:600; }
    .util-fail { color:#b91c1c; font-weight:600; }
    svg { background:#fff; border:1px dashed #cbd5e1; border-radius:8px; margin-top:10px; }
    .report-title { background:var(--main); color:#fff; padding:8px 14px; border-radius:8px; font-weight:600; }
    .fade-in { animation: fadeIn .4s ease-in; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(8px);} to{opacity:1; transform:translateY(0);} }
  </style>
</head>
<body class="container py-4">

  <div class="d-flex align-items-center mb-3">
    <i class="bi bi-tree-fill fs-3 text-primary me-2"></i>
    <h2 class="mb-0">LINEAL Timber Design — EC5 Calculator</h2>
  </div>

  <!-- Input form -->
  <form id="calcForm" class="row g-3">
    <div class="col-md-3">
      <label class="form-label">Section Type</label>
      <select id="section_type" class="form-select">
        {% for s in section_types %}
        <option value="{{s}}">{{s}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Timber Class</label>
      <select id="timber_class" class="form-select">
        {% for c in timber_classes %}
        <option value="{{c}}">{{c}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Material</label>
      <select id="material" class="form-select">
        {% for m in materials %}
        <option value="{{m}}">{{m}}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label">Service Class</label>
      <select id="service_class" class="form-select">
        <option value="1">1</option>
        <option value="2" selected>2</option>
        <option value="3">3</option>
      </select>
    </div>

    <div class="col-md-3">
      <label class="form-label">Load Duration</label>
      <select id="load_class" class="form-select">
        <option>Permanent</option>
        <option>Long-term</option>
        <option selected>Medium-term</option>
        <option>Short-term</option>
        <option>Instantaneous</option>
      </select>
    </div>

    <!-- dynamic geometry fields -->
    <div id="dynamicInputs" class="row g-3"></div>

    <!-- loads -->
    <hr>
    <div class="col-md-2"><label class="form-label">N<sub>Ed</sub> (kN)</label><input id="Ned_kN" class="form-control" value="0"></div>
    <div class="col-md-2"><label class="form-label">M<sub>yd</sub> (kNm)</label><input id="Myd_kNm" class="form-control" value="0"></div>
    <div class="col-md-2"><label class="form-label">M<sub>zd</sub> (kNm)</label><input id="Mzd_kNm" class="form-control" value="0"></div>
    <div class="col-md-2"><label class="form-label">V<sub>Ed</sub> (kN)</label><input id="Ved_kN" class="form-control" value="0"></div>

    <div class="col-12">
      <button type="button" id="runCheck" class="btn btn-primary mt-3 px-4">
        <i class="bi bi-cpu me-2"></i>Run Check
      </button>
    </div>
  </form>

  <!-- results -->
  <div id="results" class="mt-4"></div>

  <script>
    const sectionInputs = {{ section_inputs | tojson | safe }};
    const sectionSelect = document.getElementById("section_type");
    const dynamicInputs = document.getElementById("dynamicInputs");

    // generate dynamic fields
    function updateInputs() {
      dynamicInputs.innerHTML = "";
      const fields = sectionInputs[sectionSelect.value] || [];
      fields.forEach(f => {
        const col = document.createElement("div");
        col.classList.add("col-md-2");
        col.innerHTML = `<label class="form-label">${f} (mm)</label>
                         <input type="number" id="${f}" class="form-control" value="200">`;
        dynamicInputs.appendChild(col);
      });
    }
    sectionSelect.addEventListener("change", updateInputs);
    updateInputs();

    // draw simple SVG previews
    function drawSection(section, geom) {
      const color = "#3b82f6";
      let svg="";
      if(section==="Rectangle"){
        const b=geom.b,h=geom.h;
        svg=`<svg width="${b/2+60}" height="${h/2+60}">
          <rect x="30" y="30" width="${b/2}" height="${h/2}" fill="${color}" opacity="0.85"/>
        </svg>`;
      }else if(section==="Circle"||section==="CHS"){
        const d=geom.d;
        svg=`<svg width="${d/2+60}" height="${d/2+60}">
          <circle cx="${d/4+30}" cy="${d/4+30}" r="${d/4}" fill="${color}" opacity="0.85"/></svg>`;
      }else if(section==="RHS/SHS"){
        const b=geom.b,h=geom.h,t=geom.t;
        svg=`<svg width="${b/2+60}" height="${h/2+60}">
          <rect x="30" y="30" width="${b/2}" height="${h/2}" fill="none" stroke="${color}" stroke-width="${t/4}"/></svg>`;
      }else{
        svg=`<svg width="200" height="100"><text x="20" y="60">Preview N/A</text></svg>`;
      }
      return svg;
    }

    // safe numeric display
    function safe(v, dec=2) {
      return (v!==undefined && v!==null && !isNaN(v)) ? v.toFixed(dec) : "—";
    }

    // run check
    document.getElementById("runCheck").addEventListener("click", async()=>{
      const payload={
        section_type:sectionSelect.value,
        timber_class:document.getElementById("timber_class").value,
        material:document.getElementById("material").value,
        service_class:document.getElementById("service_class").value,
        load_class:document.getElementById("load_class").value,
        Ned_kN:document.getElementById("Ned_kN").value,
        Myd_kNm:document.getElementById("Myd_kNm").value,
        Mzd_kNm:document.getElementById("Mzd_kNm").value,
        Ved_kN:document.getElementById("Ved_kN").value
      };
      (sectionInputs[sectionSelect.value]||[]).forEach(f=>{
        payload[f]=document.getElementById(f).value;
      });

      const res=await fetch("/api/run_check",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
      const data=await res.json();
      const geom=payload; const svg=drawSection(sectionSelect.value,geom);

      // Extended report
      const report=`
        <div class="card p-4 fade-in">
          <div class="report-title mb-3">
            <i class="bi bi-clipboard-data me-2"></i>Extended Report — ${sectionSelect.value}
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="result-box">
                <b>Geometry:</b><br>
                A = ${safe(data.geom?.A,1)} mm²<br>
                I<sub>y</sub> = ${safe(data.geom?.Iy,0)} mm⁴<br>
                I<sub>z</sub> = ${safe(data.geom?.Iz,0)} mm⁴<br>
                W<sub>y</sub> = ${safe(data.geom?.Wy,1)} mm³<br>
                W<sub>z</sub> = ${safe(data.geom?.Wz,1)} mm³<br>
              </div>

              <div class="result-box">
                <b>Design strengths (αντοχές):</b><br>
                f<sub>t,0,d</sub> = ${safe(data.ft0d)} MPa<br>
                f<sub>c,0,d</sub> = ${safe(data.fc0d)} MPa<br>
                f<sub>m,d</sub> = ${safe(data.fmd)} MPa<br>
                f<sub>v,d</sub> = ${safe(data.fvd)} MPa
              </div>

              <div class="result-box">
                <b>Stresses:</b><br>
                σ<sub>c</sub> = ${safe(data.sigma_c)} MPa<br>
                σ<sub>t</sub> = ${safe(data.sigma_t)} MPa<br>
                σ<sub>My</sub> = ${safe(data.sigma_my)} MPa<br>
                σ<sub>Mz</sub> = ${safe(data.sigma_mz)} MPa<br>
                τ<sub>v</sub> = ${safe(data.tau_v)} MPa
              </div>

              <div class="result-box">
                <b>Utilization Ratios:</b><br>
                Axial tension: <span class="${data.util_tension<1?'util-pass':'util-fail'}">${safe(data.util_tension,3)}</span><br>
                Shear: <span class="${data.util_shear<1?'util-pass':'util-fail'}">${safe(data.util_shear,3)}</span><br>
                Bending: <span class="${data.util_bending<1?'util-pass':'util-fail'}">${safe(data.util_bending,3)}</span><br>
                N-M (Tension): <span class="${data.util_NM_tension<1?'util-pass':'util-fail'}">${safe(data.util_NM_tension,3)}</span><br>
                N-M (Compression): <span class="${data.util_NM_compression<1?'util-pass':'util-fail'}">${safe(data.util_NM_compression,3)}</span>
              </div>
            </div>

            <div class="col-md-6 d-flex flex-column align-items-center justify-content-center">
              ${svg}
              <small class="text-muted mt-2">Geometric preview (not to scale)</small>
            </div>
          </div>
        </div>`;
      document.getElementById("results").innerHTML=report;
    });
  </script>
</body>
</html>
