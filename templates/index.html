<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Timber EC5 Checks</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <style>
        body {
            background: #f5f7fb;
        }
        .card {
            border-radius: 0.75rem;
        }
        .badge-shape {
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
        }
        .util-ok {
            color: #198754;
            font-weight: 600;
        }
        .util-not-ok {
            color: #dc3545;
            font-weight: 700;
        }
        .governing-row {
            border-left: 4px solid #0d6efd;
            background: #e9f2ff;
        }
        .small-label {
            font-size: 0.8rem;
            color: #666;
        }
        .dims-group {
            display: none;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
    <div class="container-fluid">
        <span class="navbar-brand">Timber EC5 Checker</span>
    </div>
</nav>

<div class="container-fluid mb-4">
    <div class="row g-4">
        <!-- LEFT: FORM -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-3">Input</h5>
                    {% if errors %}
                        <div class="alert alert-danger">
                            <ul class="mb-0">
                                {% for e in errors %}
                                    <li>{{ e }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}

                    <form method="post" novalidate>
                        <!-- Section type -->
                        <div class="mb-3">
                            <label class="form-label">Section shape</label>
                            <select id="shape-select" name="shape" class="form-select">
                                {% for shape in shapes %}
                                    <option value="{{ shape }}"
                                            {% if shape == selected_shape %}selected{% endif %}>
                                        {{ shape }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="form-text small-label">
                                Fields below change depending on shape.
                            </div>
                        </div>

                        <!-- Timber class / material -->
                        <div class="mb-3">
                            <label class="form-label">Timber strength class</label>
                            <select name="timber_class" class="form-select">
                                {% for cls in timber_classes %}
                                    <option value="{{ cls }}"
                                            {% if cls == selected_class %}selected{% endif %}>
                                        {{ cls }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Material type (for kmod)</label>
                            <select name="material_type" class="form-select">
                                {% for mt in material_types %}
                                    <option value="{{ mt }}"
                                            {% if mt == selected_material %}selected{% endif %}>
                                        {{ mt }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
<div class="mb-3 mt-2">
    <label class="form-label">Î³<sub>M</sub> (material partial factor)</label>
    <input type="number" step="0.01" name="gamma_M" class="form-control"
           value="{{ form_values.get('gamma_M', gamma_default) }}">
    <div class="form-text small-label">
        Leave empty or 0 to use default for the selected material
        (â‰ˆ {{ "%.2f"|format(gamma_default) }}).
    </div>
</div>

                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">Service class</label>
                                <select name="service_class" class="form-select">
                                    {% for sc in service_classes %}
                                        <option value="{{ sc }}"
                                                {% if sc == selected_service %}selected{% endif %}>
                                            {{ sc }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">Load duration</label>
                                <select name="load_class" class="form-select">
                                    {% for lc in load_classes %}
                                        <option value="{{ lc }}"
                                                {% if lc == selected_load_class %}selected{% endif %}>
                                            {{ lc }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <hr>

                        <!-- Dimensions (dynamic by shape) -->
                        <h6 class="mt-3">Section dimensions</h6>

                        <!-- Rectangle -->
                        <div class="dims-group" data-shape="rectangle">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">b</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Circle / CHS -->
                        <div class="dims-group" data-shape="circle chs">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">d</label>
                                    <input type="number" step="any" name="d" class="form-control"
                                           value="{{ form_values.get('d', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">t (CHS)</label>
                                    <input type="number" step="any" name="t" class="form-control"
                                           value="{{ form_values.get('t', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Ellipse -->
                        <div class="dims-group" data-shape="ellipse">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">a (major)</label>
                                    <input type="number" step="any" name="a" class="form-control"
                                           value="{{ form_values.get('a', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">b (minor)</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- RHS -->
                        <div class="dims-group" data-shape="rhs">
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label">b</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">t</label>
                                    <input type="number" step="any" name="t" class="form-control"
                                           value="{{ form_values.get('t', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- I-section -->
                        <div class="dims-group" data-shape="i_section">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">b</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">tw</label>
                                    <input type="number" step="any" name="tw" class="form-control"
                                           value="{{ form_values.get('tw', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">tf</label>
                                    <input type="number" step="any" name="tf" class="form-control"
                                           value="{{ form_values.get('tf', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- T-section -->
                        <div class="dims-group" data-shape="t_section">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">b</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">tw</label>
                                    <input type="number" step="any" name="tw" class="form-control"
                                           value="{{ form_values.get('tw', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">tf</label>
                                    <input type="number" step="any" name="tf" class="form-control"
                                           value="{{ form_values.get('tf', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Trapezoid -->
                        <div class="dims-group" data-shape="trapezoid">
                            <div class="row g-2">
                                <div class="col-4">
                                    <label class="form-label">b1 (bottom)</label>
                                    <input type="number" step="any" name="b1" class="form-control"
                                           value="{{ form_values.get('b1', '') }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">b2 (top)</label>
                                    <input type="number" step="any" name="b2" class="form-control"
                                           value="{{ form_values.get('b2', '') }}">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                            </div>
                        </div>

                        <!-- Triangle -->
                        <div class="dims-group" data-shape="triangle">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label">b</label>
                                    <input type="number" step="any" name="b" class="form-control"
                                           value="{{ form_values.get('b', '') }}">
                                </div>
                                <div class="col-6">
                                    <label class="form-label">h</label>
                                    <input type="number" step="any" name="h" class="form-control"
                                           value="{{ form_values.get('h', '') }}">
                                </div>
                            </div>
                        </div>

                        <div class="form-text small-label mt-1">
                            Units must be consistent (e.g. mm).
                        </div>

                        <hr>

                        <!-- Internal forces -->
                        <h6 class="mt-3">Internal forces (design values)</h6>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label">N [N]</label>
                                <input type="number" step="any" name="N" class="form-control"
                                       value="{{ form_values.get('N', '') }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Mx [NÂ·mm]</label>
                                <input type="number" step="any" name="Mx" class="form-control"
                                       value="{{ form_values.get('Mx', '') }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">My [NÂ·mm]</label>
                                <input type="number" step="any" name="My" class="form-control"
                                       value="{{ form_values.get('My', '') }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Vx [N]</label>
                                <input type="number" step="any" name="Vx" class="form-control"
                                       value="{{ form_values.get('Vx', '') }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Vy [N]</label>
                                <input type="number" step="any" name="Vy" class="form-control"
                                       value="{{ form_values.get('Vy', '') }}">
                            </div>
                            <div class="col-6">
                                <label class="form-label">T [NÂ·mm]</label>
                                <input type="number" step="any" name="T" class="form-control"
                                       value="{{ form_values.get('T', '') }}">
                            </div>
                        </div>

                        <div class="d-grid mt-4">
                            <button type="submit" class="btn btn-primary">
                                Run EC5 checks
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT: RESULTS -->
        <div class="col-lg-8">
            {% if result %}
                <div class="row g-4">
                    <!-- Summary header -->
                    <div class="col-12">
                        <div class="card shadow-sm mb-2">
                            <div class="card-body d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="badge bg-secondary badge-shape">
                                        {{ result.shape }}
                                    </span>
                                    <h5 class="mt-2 mb-1">
                                        Timber class: {{ selected_class }}
                                    </h5>
                                    <p class="mb-0 small">
                                        Material: {{ selected_material }} &nbsp;|&nbsp;
                                        Service class: {{ selected_service }} &nbsp;|&nbsp;
                                        Load duration: {{ selected_load_class }}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="small text-muted">Governing check</div>
                                    {% set g = result.governing_check %}
                                    <div>
                                        <strong>{{ g.name }}</strong><br>
                                        {% if g.utilization <= g.limit %}
                                            <span class="util-ok">
                                                Î· = {{ "%.3f"|format(g.utilization) }}
                                            </span>
                                        {% else %}
                                            <span class="util-not-ok">
                                                Î· = {{ "%.3f"|format(g.utilization) }}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Section properties -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">Section properties</h6>
                                {% if section_props %}
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                        {% for k, v in section_props.items() %}
                                            <tr>
                                                <td>{{ k }}</td>
                                                <td class="text-end">
                                                    {% if v is not none %}
                                                        {{ "%.4g"|format(v) }}
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <p class="text-muted mb-0">No section properties computed.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Design strengths -->
                    <div class="col-md-6">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">Design strengths (EC5)</h6>
                                {% if strengths %}
                                    <table class="table table-sm mb-0">
                                        <tbody>
                                        {% for k, v in strengths.items() %}
                                            <tr>
                                                <td>{{ k }}</td>
                                                <td class="text-end">
                                                    {% if v is not none %}
                                                        {{ "%.3f"|format(v) }}
                                                    {% else %}
                                                        -
                                                    {% endif %}
                                                </td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <p class="text-muted mb-0">No strengths computed.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Checks table -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title">Checks</h6>
                                {% if result.checks %}
                                    <table class="table table-sm align-middle">
                                        <thead>
                                        <tr>
                                            <th>Check</th>
                                            <th class="text-end">Î·</th>
                                            <th class="text-end">Limit</th>
                                            <th>Status</th>
                                            <th>Details</th>
                                        </tr>
                                        </thead>
                                        <tbody>
                                        {% for chk in result.checks %}
                                            {% set is_governing = (chk.name == result.governing_check.name) %}
                                            <tr class="{% if is_governing %}governing-row{% endif %}">
                                                <td>{{ chk.name }}</td>
                                                <td class="text-end">
                                                    {% if chk.utilization <= chk.limit %}
                                                        <span class="util-ok">
                                                            {{ "%.3f"|format(chk.utilization) }}
                                                        </span>
                                                    {% else %}
                                                        <span class="util-not-ok">
                                                            {{ "%.3f"|format(chk.utilization) }}
                                                        </span>
                                                    {% endif %}
                                                </td>
                                                <td class="text-end">{{ "%.3f"|format(chk.limit) }}</td>
                                                <td>
                                                    {% if chk.ok %}
                                                        <span class="badge bg-success">OK</span>
                                                    {% else %}
                                                        <span class="badge bg-danger">NOT OK</span>
                                                    {% endif %}
                                                </td>
                                                <td><span class="small">{{ chk.details }}</span></td>
                                            </tr>
                                        {% endfor %}
                                        </tbody>
                                    </table>
                                {% else %}
                                    <p class="text-muted mb-0">No checks performed.</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <!-- Initial welcome text -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h5>Welcome ðŸ‘‹</h5>
                        <p class="mb-1">
                            Choose the section shape, enter dimensions, timber class, material parameters and internal forces,
                            then click <strong>Run EC5 checks</strong>.
                        </p>
                        <p class="mb-0 small text-muted">
                            Units must be consistent (e.g. forces in N, moments in NÂ·mm, dimensions in mm).
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
    function updateDimsVisibility() {
        const select = document.getElementById("shape-select");
        const shape = select.value;
        const groups = document.querySelectorAll(".dims-group");

        groups.forEach(group => {
            const shapes = group.dataset.shape.split(" ");
            const inputs = group.querySelectorAll("input");

            if (shapes.includes(shape)) {
                group.style.display = "block";
                inputs.forEach(i => i.disabled = false);
            } else {
                group.style.display = "none";
                inputs.forEach(i => i.disabled = true);
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        updateDimsVisibility();
        const select = document.getElementById("shape-select");
        select.addEventListener("change", updateDimsVisibility);
    });
</script>

</body>
</html>
